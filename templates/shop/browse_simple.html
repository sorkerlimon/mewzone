{% extends 'shop/base_ecommerce.html' %}

{% block title %}Browse Cats - MewZone{% endblock %}

{% block content %}
{% include 'shop/partials/header_nav.html' %}

    <!-- Mobile Filter Toggle Button -->
    <div class="mobile-filter-toggle d-lg-none">
        <button class="btn btn-primary w-100" id="mobileFilterToggle">
            <i class="fas fa-filter me-2"></i>Filter Cats
        </button>
    </div>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Left Sidebar - Filters -->
            <div class="col-lg-3">
                <div class="filter-sidebar bg-white p-4 rounded shadow-sm" id="filterSidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Cats</h5>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-primary" id="clearFilters">
                            <i class="fas fa-undo me-1"></i> Clear All
                        </button>
                        <button class="btn btn-sm btn-outline-secondary d-lg-none" id="closeMobileFilter">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Search by Name -->
                <div class="mb-4">
                    <h6>Filter by Name</h6>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" placeholder="Enter cat name" id="nameFilter">
                        <button class="btn btn-outline-secondary" type="button" id="clearName">Clear</button>
                    </div>
                </div>

                <!-- Price Range -->
                <div class="mb-4">
                    <h6>Filter by Price</h6>
                    <div class="row">
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Min - $0" id="minPrice">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control" placeholder="Max - $5000" id="maxPrice">
                        </div>
                    </div>
                </div>

                <!-- Breed Filter -->
                <div class="mb-4">
                    <h6>Filter by Breed</h6>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" placeholder="Search breed..." id="breedSearch">
                    </div>
                    <div class="breed-list" id="breedList">
                        {% for b in breed_counts %}
                        <div class="form-check">
                            <input class="form-check-input breed-filter" type="checkbox" value="{{ b.breed__name }}" data-id="{{ b.breed__id }}" id="breed_{{ forloop.counter }}">
                            <label class="form-check-label" for="breed_{{ forloop.counter }}">{{ b.breed__name }} ({{ b.cnt }})</label>
                        </div>
                        {% empty %}
                        <p class="text-muted">No breeds found</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Gender Filter -->
                <div class="mb-4">
                    <h6>Filter by Gender</h6>
                    {% for g in gender_counts %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="{{ g.gender|upper }}" id="gender_{{ forloop.counter }}">
                        <label class="form-check-label" for="gender_{{ forloop.counter }}">{{ g.gender|title }} ({{ g.cnt }})</label>
                    </div>
                    {% empty %}
                    <p class="text-muted">No gender data</p>
                    {% endfor %}
                </div>

                <!-- Color Filter -->
                <div class="mb-4">
                    <h6>Filter by Color</h6>
                    <div id="colorList">
                        {% for row in color_counts %}
                        {% if row.color %}
                        <div class="form-check">
                            <input class="form-check-input color-filter" type="checkbox" value="{{ row.color }}" id="color_{{ forloop.counter }}">
                            <label class="form-check-label" for="color_{{ forloop.counter }}">{{ row.color|title }} ({{ row.cnt }})</label>
                        </div>
                        {% endif %}
                        {% empty %}
                        <p class="text-muted">No color data</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Age Filter -->
                <div class="mb-4">
                    <h6>Filter by Age</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="kitten" id="age1">
                        <label class="form-check-label" for="age1">Kitten (0-1 year) (20)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="young" id="age2">
                        <label class="form-check-label" for="age2">Young (1-3 years) (15)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="adult" id="age3">
                        <label class="form-check-label" for="age3">Adult (3-7 years) (8)</label>
                    </div>
                </div>

            </div>
        </div>

        <!-- Main Content Area -->
        <div class="col-lg-9">
            <!-- Latest Cats Section -->
            <div class="product-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-star text-warning me-2"></i>Latest Cats
                    </h3>
                    <a href="#" class="btn btn-outline-primary">See More <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
                <div id="latestGrid">
                    {% include 'shop/partials/product_grid.html' with products=latest_products %}
                </div>
            </div>

            <!-- Best Sellers Section -->
            <div class="product-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-fire text-danger me-2"></i>Best Sellers
                    </h3>
                    <a href="#" class="btn btn-outline-primary">See More <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
                <div class="row">
                    {% for product in best_sellers %}
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="cat-card">
                            <div class="cat-image">
                                {% with image=product.images.all|first %}
                                    {% if image %}
                                        <img src="{{ image.image.url }}" alt="{{ product.name }}">
                                    {% else %}
                                        <img src="https://images.unsplash.com/photo-1573865526739-1069f4dd8abd?w=300&h=200&fit=crop" alt="{{ product.name }}">
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="cat-info">
                                <h6 class="cat-title"><a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-dark">{{ product.name }}</a></h6>
                                <p class="cat-breed">{{ product.breed.name }} ‚Ä¢ {{ product.get_gender_display }}</p>
                                <div class="cat-price">${{ product.price|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center"><p class="text-muted">No best sellers yet.</p></div>
                    {% endfor %}
                </div>
            </div>

            <!-- Newly Coming Section -->
            <div class="product-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="mb-0">
                        <i class="fas fa-plus-circle text-success me-2"></i>Newly Coming
                    </h3>
                    <a href="#" class="btn btn-outline-primary">See More <i class="fas fa-arrow-right ms-1"></i></a>
                </div>
                <div class="row">
                    {% for product in newly_coming %}
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="cat-card">
                            <div class="cat-image">
                                {% with image=product.images.all|first %}
                                    {% if image %}
                                        <img src="{{ image.image.url }}" alt="{{ product.name }}">
                                    {% else %}
                                        <img src="https://images.unsplash.com/photo-1513245543132-31f507417b26?w=300&h=200&fit=crop" alt="{{ product.name }}">
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="cat-info">
                                <h6 class="cat-title"><a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-dark">{{ product.name }}</a></h6>
                                <p class="cat-breed">{{ product.breed.name }} ‚Ä¢ {{ product.get_gender_display }}</p>
                                <div class="cat-price">${{ product.price|floatformat:2 }}</div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center"><p class="text-muted">No new arrivals yet.</p></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chat Widget -->
<div class="chat-widget position-fixed bottom-0 end-0 p-3">
    <!-- Chat Icon (Initial State) -->
    <div class="chat-icon" id="chatIcon">
        <div class="chat-icon-circle">
            <i class="fas fa-comments"></i>
            <span class="chat-notification">1</span>
        </div>
    </div>
    
    <!-- Chat Box (Expanded State) -->
    <div class="chat-box" id="chatBox" style="display: none;">
        <div class="chat-header">
            <div class="d-flex align-items-center">
                <div class="chat-avatar">
                    <i class="fas fa-cat"></i>
                </div>
                <div class="chat-info">
                    <h6 class="mb-0">MewZone Support</h6>
                    <small class="text-muted">Online now</small>
                </div>
            </div>
            <button class="btn btn-sm btn-outline-light" id="closeChat">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-message received">
                <div class="message-content">
                    <p>Hello! How can I help you find the perfect cat today? üê±</p>
                    <small class="message-time">2:03 PM</small>
                </div>
            </div>
        </div>
        <div class="chat-footer">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Type your message..." id="chatInput">
                <button class="btn btn-primary" type="button" id="sendMessage">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Simple JavaScript without complex data structures
document.addEventListener('DOMContentLoaded', function() {
    // Chat widget functionality
    const chatIcon = document.getElementById('chatIcon');
    const chatBox = document.getElementById('chatBox');
    const closeChat = document.getElementById('closeChat');
    const chatInput = document.getElementById('chatInput');
    const sendMessage = document.getElementById('sendMessage');
    
    // Open chat when icon is clicked
    if (chatIcon && chatBox) {
        chatIcon.addEventListener('click', function() {
            chatIcon.style.display = 'none';
            chatBox.style.display = 'block';
        });
    }
    
    // Close chat when close button is clicked
    if (closeChat && chatBox && chatIcon) {
        closeChat.addEventListener('click', function() {
            chatBox.style.display = 'none';
            chatIcon.style.display = 'block';
        });
    }
    
    // Send message functionality
    if (sendMessage && chatInput) {
        sendMessage.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message) {
                addMessage(message, 'sent');
                chatInput.value = '';
            }
        });
    }
    
    // Send message on Enter key
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const message = chatInput.value.trim();
                if (message) {
                    addMessage(message, 'sent');
                    chatInput.value = '';
                }
            }
        });
    }
    
    // Function to add messages
    function addMessage(text, type) {
        const chatBody = document.getElementById('chatBody');
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${type}`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <p>${text}</p>
                <small class="message-time">${timeString}</small>
            </div>
        `;
        
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Mobile menu toggle functionality
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileNavMenu = document.getElementById('mobileNavMenu');
    const closeMobileMenu = document.getElementById('closeMobileMenu');
    
    if (mobileMenuToggle && mobileNavMenu) {
        mobileMenuToggle.addEventListener('click', function() {
            mobileNavMenu.classList.add('show');
            document.body.style.overflow = 'hidden';
        });
    }
    
    if (closeMobileMenu && mobileNavMenu) {
        closeMobileMenu.addEventListener('click', function() {
            mobileNavMenu.classList.remove('show');
            document.body.style.overflow = 'auto';
        });
    }
    
    // Close mobile menu when clicking outside
    if (mobileNavMenu) {
        mobileNavMenu.addEventListener('click', function(e) {
            if (e.target === mobileNavMenu) {
                mobileNavMenu.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        });
    }

    // Mobile filter toggle functionality
    const mobileFilterToggle = document.getElementById('mobileFilterToggle');
    const filterSidebar = document.getElementById('filterSidebar');
    const closeMobileFilter = document.getElementById('closeMobileFilter');
    
    function openMobileFilter() {
        filterSidebar.style.display = 'block';
        filterSidebar.style.position = 'fixed';
        filterSidebar.style.top = '0';
        filterSidebar.style.left = '0';
        filterSidebar.style.width = '100%';
        filterSidebar.style.height = '100vh';
        filterSidebar.style.zIndex = '9999';
        filterSidebar.style.overflowY = 'auto';
        filterSidebar.style.padding = '20px';
        document.body.style.overflow = 'hidden';
        
        // Change button text
        mobileFilterToggle.innerHTML = '<i class="fas fa-times me-2"></i>Close Filters';
    }
    
    function closeMobileFilterFunc() {
        filterSidebar.style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // Change button text back
        mobileFilterToggle.innerHTML = '<i class="fas fa-filter me-2"></i>Filter Cats';
    }
    
    if (mobileFilterToggle && filterSidebar) {
        mobileFilterToggle.addEventListener('click', function() {
            if (filterSidebar.style.display === 'none' || filterSidebar.style.display === '') {
                openMobileFilter();
            } else {
                closeMobileFilterFunc();
            }
        });
    }
    
    // Close mobile filter when close button is clicked
    if (closeMobileFilter) {
        closeMobileFilter.addEventListener('click', function() {
            closeMobileFilterFunc();
        });
    }

    // Dynamic filtering (no Apply button needed)
    const clearFiltersBtn = document.getElementById('clearFilters');
    const latestGrid = document.getElementById('latestGrid');

    function gatherFilters() {
        const params = new URLSearchParams();
        const name = document.getElementById('nameFilter').value.trim();
        if (name) params.set('name', name);
        const minP = document.getElementById('minPrice').value;
        const maxP = document.getElementById('maxPrice').value;
        if (minP) params.set('min', minP);
        if (maxP) params.set('max', maxP);
        document.querySelectorAll('#breedList .breed-filter').forEach(cb=>{ if (cb.checked) params.append('breed', cb.getAttribute('data-id') || cb.value); });
        document.querySelectorAll('input[id^="gender_"]').forEach(cb=>{ if (cb.checked) params.append('gender', cb.value.toUpperCase()); });
        document.querySelectorAll('#colorList .color-filter').forEach(cb=>{ if (cb.checked) params.append('color', cb.value); });
        return params.toString();
    }

    let filterTimeout; // debounce
    function triggerFilter() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(async () => {
            const qs = gatherFilters();
            try {
                const res = await fetch(`/browse/filter/?${qs}`);
                const data = await res.json();
                if (latestGrid) latestGrid.innerHTML = data.html;
                if (window.innerWidth < 992) closeMobileFilterFunc();
            } catch (e) { console.warn('Filter error', e); }
        }, 250);
    }

    // Wire inputs: change triggers filter
    document.getElementById('nameFilter').addEventListener('input', triggerFilter);
    document.getElementById('minPrice').addEventListener('input', triggerFilter);
    document.getElementById('maxPrice').addEventListener('input', triggerFilter);
    document.querySelectorAll('#breedList .breed-filter').forEach(cb=> cb.addEventListener('change', triggerFilter));
    document.querySelectorAll('input[id^="gender_"]').forEach(cb=> cb.addEventListener('change', triggerFilter));
    document.querySelectorAll('#colorList .color-filter').forEach(cb=> cb.addEventListener('change', triggerFilter));

    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            // Clear all checkboxes
            document.querySelectorAll('.filter-sidebar input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });
            // Clear text inputs
            document.querySelectorAll('.filter-sidebar input[type="text"], .filter-sidebar input[type="number"]').forEach(input => {
                input.value = '';
            });
            triggerFilter();
        });
    }
});
            </script>

    {% include 'shop/partials/footer.html' %}
        {% endblock %}
